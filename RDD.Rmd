---
title: "Regression Discontinuity Design"
author:
  - name: Vincent Bagilet 
    url: https://www.sipa.columbia.edu/experience-sipa/sipa-profiles/vincent-bagilet
    affiliation: Columbia University
    affiliation_url: https://www.columbia.edu/
  - name: LÃ©o Zabrocki 
    url: https://www.parisschoolofeconomics.eu/en/
    affiliation: Paris School of Economics
    affiliation_url: https://www.parisschoolofeconomics.eu/en/
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "images/",
               cache.path = "cache/",
               cache = FALSE,
               echo = TRUE, #set to false to hide code
               message = FALSE,
               warning = FALSE,
               out.width = "85%",
               dpi = 200,
               fig.align = "center")  
```  

## Purpose of the document

In this document, we run a simulation exercise to illustrate the existence of a trade-off between Omitted Variable Bias (OVB) and type M error in the case of the Regression Discontinuity Design (RDD). This trade-off is mediated by the size of the bandwidth considered in the analysis.

```{r packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) 
library(knitr) 
library(mediocrethemes)

set_mediocre_all()
```


## Extremely simple example

We first implement a very simple example to get our hands on simulating a RDD with an omitted variable bias.

First, we define the values of the various parameters: 

```{r}
n_indiv <- 10000
n_period <- 1
mu_x <- 2
sigma_x <- 4
sigma_e <- 0.4
mu_u <- 1
sigma_u <- 0.2

alpha <- 0
gamma <- 0.3
delta_y <- 10
delta_x <- 10
beta <- 1
sigma_t <- 2
```

Then, we create a tibble containing the main variables along with Y(0):

```{r}
data_rdd <- 
  tibble(indiv = 1:n_indiv) %>% 
  crossing(period = 1:n_period) %>% 
  mutate(
    uniq_id = paste(indiv, period, sep = "_"),
    e = rnorm(n_indiv*n_period, 0, sigma_e),
    u = rnorm(n_indiv*n_period, mu_u, sigma_u),
    x = rnorm(n_indiv*n_period, mu_x, sigma_x)+ delta_x*u,
    Y0 = alpha + gamma*x + delta_y*u + e
  )
```

We then draw the treated

```{r}
draw_treated <- function(data) {
    threshold_pos <- runif(1, 0, 1) 
    
    data <- data %>%
      mutate(
        threshold = quantile(.data[["x"]], threshold_pos, names = FALSE),
        treated = .data[["x"]] > threshold
      ) %>%
      select(-threshold) 
    
  return(data)
}

data_rdd_treated <- draw_treated(data_rdd) %>% 
  mutate(Y1 = Y0 + beta*treated + rnorm(nrow(.), 0, sigma_t))
```


```{r}
data_rdd_treated %>% 
  ggplot(aes(x = x, y = u)) +
  geom_point()

lm(data = data_rdd_treated, formula = Y1 ~ treated + x)
```


