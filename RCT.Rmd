---
title: '"Simulations" RCT'
author:
  - name: Vincent Bagilet 
    url: https://vincentbagilet.github.io/
    affiliation: Columbia University
    affiliation_url: https://www.columbia.edu/
  - name: LÃ©o Zabrocki 
    url: https://www.parisschoolofeconomics.eu/en/
    affiliation: Paris School of Economics
    affiliation_url: https://www.parisschoolofeconomics.eu/en/
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup_IV, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "images/",
               cache.path = "cache/",
               cache = FALSE,
               echo = TRUE, #set to false to hide code
               message = FALSE,
               warning = FALSE,
               out.width = "85%",
               dpi = 200,
               fig.align = "center")  
```  

```{r packages_IV, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) 
library(knitr) 
library(mediocrethemes)
library(haven)
library(here)
library(readxl)
library(retrodesign)
library(gganimate)

set.seed(3)

set_mediocre_all(pal = "coty")
```

## Purpose of the document

## Replication of RCTs

We want to look at replications of RCTs in Development Economics. To do so, we use [the list of replication papers put together by Sandip Sukhtankar](https://www.aeaweb.org/articles?id=10.1257/aer.p20171120). We may also end up looking at replications in experimental economics, using [the paper by Camerer et al.](https://www.science.org/doi/10.1126/science.aaf0918).

We gather the list of RCTs that have been replicated in Development Economics.

```{r rep_dvpt}
rep_dvpt <- read_dta(here("Misc", "replication_data_final.dta"))

rep_dvpt %>% 
  filter((RCT == "Yes") & (Replicated == "Replicated")) %>% 
  .$ReplicationPaperTitle
```


Now look at table S1 in Camerer et al. We import it and work on it. Note that some pvalues are strictly smaller than 0.001. As we do not have more information, we set them to 0.001

We want to compute the power of the initial analysis if the true effect is in fact equal to the replication's.

```{r camerer}
rep_camerer <- read_excel(here("Misc", "rep_camerer.xlsx"))

retro_camerer <- rep_camerer %>% 
  mutate(
    se_original = effect_original/qnorm(1 - pvalue_original), #incorrect
    se_rep = effect_rep/qnorm(1 - pvalue_rep) #incorrect
  ) %>% 
  select(A = effect_rep, s = se_original) %>% 
  # select(A, s) %>% 
  pmap_dfr(retrodesign) %>% 
  cbind(rep_camerer) %>% 
  as_tibble()

retro_camerer %>%
  ggplot() +
  geom_histogram(aes(x = exaggeration))
# 
# retro_camerer %>% 
#   ggplot() +
#   geom_histogram(aes(x = power))
# 
# retro_camerer %>% 
#   count(exaggeration > 1.5)

1/median(retro_camerer$exaggeration)

median(retro_camerer$power)
```


Analyzing just one study approximately at random

```{r echo=FALSE, fig.height=4.3, fig.width=9, out.width=1200, dpi = 700}
random_study <- rep_camerer %>% 
  # slice_sample(n = 1) %>%
  slice(10) %>% 
  mutate(
    se_original = effect_original/qnorm(1 - pvalue_original), #incorrect
    se_rep = effect_rep/qnorm(1 - pvalue_rep) #incorrect
  ) 

data_graph_distrib <- rnorm(random_study$effect_rep, random_study$se_original, n = 500) %>% 
  as_tibble() %>% 
  mutate(
    n = row_number(),
    non_significant = dplyr::between(
      value, 
      - 1.96*sd(value), 
      1.96*sd(value)
    ),
    significant = ifelse(non_significant, "Non significant", "Significant") 
  ) 

data_graph_distrib %>% 
  ggplot(aes(x = n, y = value, color = significant)) + 
  geom_point(alpha = 0.8) +
  #original study
  geom_point(aes(x = -30, y = random_study$effect_original), color = "darkred", size = 2) +
  geom_linerange(aes(
    x = -30,
    ymin = random_study$effect_original - 1.96*random_study$se_original,
    ymax = random_study$effect_original + 1.96*random_study$se_original), color = "darkred") +
  #replication 
  geom_point(aes(x = -20, y = random_study$effect_rep), color = "darkblue", size = 2) +
  geom_linerange(aes(
    x = -20,
    ymin = random_study$effect_rep - 1.96*random_study$se_rep,
    ymax = random_study$effect_rep + 1.96*random_study$se_rep), color = "darkblue") +
  #repliccation with design of the original study
  geom_point(aes(x = -10, y = random_study$effect_rep), color = "gray50", size = 2) +
  geom_linerange(aes(
    x = -10,
    ymin = random_study$effect_rep - 1.96*random_study$se_original,
    ymax = random_study$effect_rep + 1.96*random_study$se_original), color = "gray50") +
  # geom_hline(aes(yintercept = mean(value)), size = 0.8) +
  geom_hline(aes(yintercept = 0), size = 0.3, linetype = "solid") +
  labs(
    title = "Illustration of type M errors",
    subtitle = "5000 draws of an estimate ~ N(Effect size in replication, std err in original study)",
    x = "Draw",
    y = "Point estimate",
    caption = "The red dot represents the estimate found in the original study"
  ) +
  scale_color_discrete(name = "")
  # transition_layers(layer_length = 2, from_blank = FALSE) #to animate
```











